function e(){chrome.contextMenus.removeAll((()=>{chrome.contextMenus.create({id:"searchWithLens",title:"Search with Google Lens",contexts:["image"]},(()=>{chrome}))}))}function o(){chrome.contextMenus.removeAll((()=>{chrome}))}function c(){chrome.storage.sync.get(["contextMenuEnabled"],(function(c){!0===c.contextMenuEnabled?e():o()}))}function t(){chrome.tabs.captureVisibleTab(null,{format:"png"},(function(e){fetch(e).then((e=>e.arrayBuffer())).then((e=>{const o=new Uint8Array(e).reduce(((e,o)=>e+String.fromCharCode(o)),""),c=btoa(o);chrome.tabs.create({url:"https://lens.google.com/"},(function(e){chrome.tabs.onUpdated.addListener((function o(t,n){t===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(o),chrome.tabs.sendMessage(t,{action:"searchScreenshot",screenshot:c}))}))}))}))}))}chrome.runtime.onInstalled.addListener((()=>{chrome.storage.sync.set({contextMenuEnabled:!0,youtubeFrameSearchEnabled:!0},(function(){setTimeout(c,100)}))})),chrome.runtime.onStartup.addListener((()=>{c()})),chrome.storage.onChanged.addListener(((c,t)=>{"sync"===t&&c.contextMenuEnabled&&(!0===c.contextMenuEnabled.newValue?e():!1===c.contextMenuEnabled.newValue&&o())})),chrome.runtime.onMessage.addListener(((c,t,n)=>("updateContextMenu"===c.action&&(c.enabled?e():o(),n({success:!0})),!0))),chrome.commands.onCommand.addListener((function(e){"search_screen"===e?t():"search_area"===e&&chrome.tabs.query({active:!0,currentWindow:!0},(([e])=>{chrome.scripting.insertCSS({target:{tabId:e.id},files:["data/inject/inject.css"]},(()=>{chrome.scripting.executeScript({target:{tabId:e.id},files:["data/inject/inject.js"]})}))}))})),chrome.contextMenus.onClicked.addListener((function(e,o){"searchWithLens"===e.menuItemId&&(function(e){if(!e.includes("data:image")){if(e.includes("/imgres?")){const o=new URL(e).searchParams.get("imgurl");if(o)return void chrome.tabs.create({url:"https://lens.google.com/uploadbyurl?url="+encodeURIComponent(o)})}chrome.tabs.create({url:"https://lens.google.com/uploadbyurl?url="+encodeURIComponent(e)})}})(e.srcUrl)})),chrome.runtime.onMessage.addListener((function(e,o,c){if("searchLocalImage"===e.action){const o=e.image;chrome.tabs.create({url:"https://lens.google.com/"},(function(e){chrome.tabs.onUpdated.addListener((function c(t,n){t===e.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(c),chrome.tabs.sendMessage(t,{action:"searchScreenshot",screenshot:o}))}))}))}})),chrome.action.onClicked.addListener((function(e){t()})),chrome.runtime.onMessage.addListener((function(e,o,c){"triggerSearch"===e.action&&t()})),chrome.runtime.onMessage.addListener(((e,o)=>{"captured"===e.method&&(function(e){return new Promise((o=>{chrome.tabs.captureVisibleTab(null,{format:"png"},(async c=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);const{left:t,top:n,width:r,height:h,devicePixelRatio:i}=e,m=new OffscreenCanvas(r*i,h*i),a=m.getContext("2d");try{const e=await fetch(c).then((e=>e.blob())),o=await createImageBitmap(e),u=await new Promise((e=>chrome.storage.local.get({quality:.95},e)));a.drawImage(o,t*i,n*i,r*i,h*i,0,0,r*i,h*i);const s=await m.convertToBlob({type:"image/png",quality:u.quality}),l=new FileReader;l.onload=()=>{const e=l.result.split(",")[1];chrome.tabs.create({url:"https://lens.google.com/"},(function(o){chrome.tabs.onUpdated.addListener((function c(t,n){t===o.id&&"complete"===n.status&&(chrome.tabs.onUpdated.removeListener(c),chrome.tabs.sendMessage(t,{action:"searchScreenshot",screenshot:e}))}))}))},l.readAsDataURL(s)}catch(u){o(u)}}))}))})(e).catch(console.error)})),chrome.webNavigation.onHistoryStateUpdated.addListener((function(e){chrome.storage.sync.get(["youtubeFrameSearchEnabled"],(function(o){!1!==o.youtubeFrameSearchEnabled&&chrome.tabs.get(e.tabId,(function(o){chrome.scripting.executeScript({target:{tabId:e.tabId},func:()=>{"undefined"!=typeof AddScreenshotButton&&AddScreenshotButton()},world:"MAIN"})}))}))}),{url:[{hostSuffix:".youtube.com"}]});